<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="somnus">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="somnus">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="somnus">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"Sidebar Position, available value":"left | right (only for Pisces | Gemini).","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>somnus</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  

  <div class="container  
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">somnus</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/08/LR-1-parser/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sf.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="somnus">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/08/LR-1-parser/" itemprop="url">LR(1) parser</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-08T13:50:11+08:00">
                2018-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/26/lexical-analyzer/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sf.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="somnus">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/26/lexical-analyzer/" itemprop="url">lexical analyzer实验报告</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-26T19:33:33+08:00">
                2018-10-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/基础/" itemprop="url" rel="index">
                    <span itemprop="name">基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="lexical-analyzer实验报告"><a href="#lexical-analyzer实验报告" class="headerlink" title="lexical analyzer实验报告"></a>lexical analyzer实验报告</h1><h1 id="Motivation-Aim"><a href="#Motivation-Aim" class="headerlink" title="Motivation/Aim"></a>Motivation/Aim</h1><p>本次实验所预计的目标是只需要接收一组正则表达式，和字符流，便可以产生匹配正则表达式的token序列，其中如果有某个串匹配多个正则表达式，则选择最长前缀的串作为token序列的输出。为了实现此目标，需要两个模块：lex模块，接收正则表达式组，输出DFA状态集。lexical analyzer模块：接收字符流，根据DFA状态集，输出oken序列。</p>
<h1 id="Content-description"><a href="#Content-description" class="headerlink" title="Content description"></a>Content description</h1><p>本次实验构造了一个lex词法分析器生成工具，输入一组正则表达式r，可以产生一个识别L(r)的DFA D，由此来构造一个lexical analyzer，利用lex产生的DFA和输入的字符流来产生这组字符流中匹配正则表达式的token序列。</p>
<h1 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h1><ul>
<li><p>lex的构造参考了《编译原理》的3.9节，涉及到的算法有：</p>
<ul>
<li>正则表达式的中缀转后缀</li>
<li>后缀正则表达式转化为正则表达式的抽象语法树</li>
<li>计算抽象语法树各位置节点的nullable，firstpos，lastpos，followpos</li>
<li>根据抽象语法树构造DFA</li>
<li>根据DFA状态集和DFAturn构造最小DFA</li>
</ul>
</li>
<li><p>补全计算nullable、firstpos、lastpos、followpos的计算规则</p>
<p>| 结点n             | nullable(n)                   | firstpos(n)                                                  | lastpos(n)                                                   | followpos                                               |<br>| —————– | —————————– | ———————————————————— | ———————————————————— | ——————————————————- |<br>| ϵ叶子节点         | true                          | null                                                         | null                                                         | null                                                    |<br>| 位置为i的叶子节点 | false                         | {i}                                                          | {i}                                                          | null                                                    |<br>| or节点n=c1\c2    | nullable(c1) or nullable(c2)  | firstpos(c1) or firstpos (c2)                                | lastpos(c1) or lastpos(c2)                                   | null                                                    |<br>| cat节点n=c1\c2   | nullable(c1) and nullable(c2) | if(nullable(c1))                           firstpos(c1) or firstpos (c2)                  else firstpos(c1) | if(nullable(c2))                           firstpos(c1) or firstpos (c2)                  else firstpos(c2) | for(i in lastpos(c1)) put firstpos(c2) in followpos(i)  |<br>| star节点n=c1*     | true                          | firstpos(c1)                                                 | lastpos(c1)                                                  | for(i in lastpos(n))    put firstpos(n) in followpos(i) |</p>
</li>
<li><p>lexical analyzer对字符流的处理采用了单字节预读的方法，从输入缓冲区取一个字符放到peek中，根据当前状态、peek和DFA决定下一状态。</p>
</li>
<li><p>错误处理：</p>
<ul>
<li><p>合法字符检查，构造了一张标识符表，可以用来检查正则表达式或者字符流中的字符是否都在处理范围内。</p>
</li>
<li><p>正则表达式出错，在第一步将中缀表达式转换为后缀表达式时，便对输入字符进行了检查，如果出错便会停止后续工作。</p>
</li>
<li>字符流出错，预读区peek检测到一个非法字符时，或者在一个非接受状态接收了不合适的字符时，会停止后续工作。</li>
</ul>
</li>
</ul>
<h1 id="Assumptions"><a href="#Assumptions" class="headerlink" title="Assumptions"></a>Assumptions</h1><ul>
<li><p>正则表达式中形如ab这样的简写用a&amp;b代替，后文中均用’a&amp;b’这样的写法来替代正则表达式’ab’。用’&amp;’替代连接符号。</p>
</li>
<li><p>《编译原理》中假设正则表达式的接受状态为’#’，这里经过实践后如果将接受状态都设置为’#’不会出现问题，但是尝试去掉’#’时产生了一些问题（后续说明），因此假设正则表达式的接收状态为’#’。</p>
</li>
<li>假设构造的lex只能识别’*’, ‘|’, ‘&amp;’(连接符号), ‘(‘, ‘)’ 这几种运算符和标识符表中的标识符所组成的正则表达式。</li>
<li>假设输入字符流以!结束（!后面还有字符则不做处理)</li>
<li>对于匹配多个正则表达式的情况，假设以最长前缀来进行匹配。</li>
</ul>
<h1 id="FA-descriptions"><a href="#FA-descriptions" class="headerlink" title="FA descriptions"></a>FA descriptions</h1><p>实验中的lex可以对任意只含’*’, ‘|’, ‘&amp;’, ‘(‘, ‘)’ 和标识符的正则表达式进行处理，这里选择了三组正则表达式：</p>
<ul>
<li><p>(a|b)*&amp;a&amp;b&amp;b&amp;#</p>
<p>a&amp;a&amp;a&amp;#</p>
</li>
<li><p>a&amp;a&amp;a&amp;#</p>
<p>b&amp;b&amp;b&amp;#</p>
<p>c&amp;c&amp;c&amp;#</p>
</li>
<li><p>(a|b)*&amp;a&amp;(a|b)&amp;#</p>
<p>(a|b)*&amp;a&amp;(a|b)&amp;(a|b)&amp;#</p>
<p>(a|b)*&amp;a&amp;(a|b)&amp;(a|b)&amp;(a|b)&amp;#</p>
</li>
</ul>
<p>正则表达式的语法分析树（以第一组正则表达式为例）</p>
<p><img src="..\images\2.jpg" alt="1540814346584"></p>
<p>（程序中使用Set存储DFAs，因此DFA的序号不是从开始1到结束n的，但是不影响结果）第一组正则表达式的DFA：</p>
<table>
<thead>
<tr>
<th></th>
<th>a</th>
<th>b</th>
<th>标识</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>5</td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>6</td>
<td>ACCEPT</td>
</tr>
<tr>
<td>5</td>
<td>7</td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>2</td>
<td>6</td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>2</td>
<td>3</td>
<td>ACCEPT</td>
</tr>
<tr>
<td>8</td>
<td>1</td>
<td>6</td>
<td>START</td>
</tr>
</tbody>
</table>
<p>第二组正则表达式的DFA：</p>
<table>
<thead>
<tr>
<th></th>
<th>a</th>
<th>b</th>
<th>c</th>
<th>标识</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td></td>
<td></td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
<td></td>
<td>7</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td></td>
<td>4</td>
<td></td>
<td>ACCEPT</td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>5</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td></td>
<td>10</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>9</td>
<td></td>
<td>7</td>
<td></td>
</tr>
<tr>
<td>7</td>
<td></td>
<td></td>
<td></td>
<td>ACCEPT</td>
</tr>
<tr>
<td>8</td>
<td>6</td>
<td>4</td>
<td>1</td>
<td>START</td>
</tr>
<tr>
<td>9</td>
<td>3</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td></td>
<td></td>
<td></td>
<td>ACCEPT</td>
</tr>
</tbody>
</table>
<p>第三组正则表达式的DFA：</p>
<table>
<thead>
<tr>
<th></th>
<th>a</th>
<th>b</th>
<th>标识</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>7</td>
<td>4</td>
<td>ACCEPT</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>6</td>
<td>ACCEPT</td>
</tr>
<tr>
<td>3</td>
<td>5</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>12</td>
<td>5</td>
<td>ACCEPT</td>
</tr>
<tr>
<td>5</td>
<td>9</td>
<td>2</td>
<td>ACCEPT</td>
</tr>
<tr>
<td>6</td>
<td>3</td>
<td>6</td>
<td>START</td>
</tr>
</tbody>
</table>
<h1 id="Data-Structures"><a href="#Data-Structures" class="headerlink" title="Data Structures"></a>Data Structures</h1><ul>
<li>实验中涉及到的数据结构有Attri，DFAGroup，DFAState，NodeType，RETreeNode，Token</li>
<li>NodeType：枚举了一个节点的类型，SYNC标识终结符节点,STAR标识*节点,OR标识|节点,CAT标识&amp;节点</li>
<li>RETreeNode：构造正则分析树的节点类，存放了节点的类型，节点的位置（如果是一个位置结点），节点标识符的值，左右子节点，nullable、firstpos、lastpos、followpos这四个用来产生DFA的关系结构。</li>
<li>Attri：枚举了一个状态的类型，START标识开始状态，ACCEPT标识接受状态，SIMPLE标识一般状态</li>
<li>DFAState：存放了DFA的单个状态的状态号、状态类型、未最小化前的转换表（map）、最小化DFA的转换表（map）。</li>
<li>DFAGroup：存放了一个DFA分组，用来对DFA进行最小化，含有一个Set\<dfastate>。</dfastate></li>
<li>Token存放了分析字符流产生的词法单元。</li>
</ul>
<h1 id="Core-Algorithms"><a href="#Core-Algorithms" class="headerlink" title="Core Algorithms"></a>Core Algorithms</h1><ul>
<li><p>Lex模块：</p>
<ul>
<li><p>多个正则表达式的组合，多个正则表达式可以使用’|’串联，需要注意给每个正则表达式最外面添加一层’()’防止运算次序出错。</p>
<ul>
<li>输入：多个正则表达式的集合A</li>
<li>输出：一个组合的正则表达式</li>
<li>方法：<ul>
<li>对于A中的每个正则表达式a，添加一层’()’，添加一个’|’</li>
<li>删除最后一个’|’</li>
</ul>
</li>
</ul>
</li>
<li><p>正则表达式的中缀转后缀，原因：利用后缀表达式，可以十分方便地构造一棵正则表达式分析树。</p>
<p>正则表达式中的运算符有’|’,’<em>‘,’&amp;’,’(‘,’)’,他们的优先级为’()’&gt;’\</em>‘&gt;’&amp;’&gt;’|’。使用一个操作符栈来完成中缀转后缀的过程。：</p>
<ul>
<li>输入：一个中缀正则表达式</li>
<li>输出：该正则表达式的后缀形式</li>
<li>方法：<ul>
<li>构造一个空操作符栈</li>
<li>遇到操作数，则直接输出。</li>
<li>遇到操作符，则依次弹出A中的操作符并输出，直到栈顶出现优先级更低的操作符或者’(‘。然后压入操作符。</li>
<li>遇到’(‘，直接压栈。</li>
<li>遇到’),依次弹出栈中的操作符并输出，直到栈顶出现’(‘，弹出’(‘。</li>
<li>最后，将栈中剩余操作符依次弹出。</li>
</ul>
</li>
</ul>
</li>
<li><p>后缀正则表达式构造语法分析树（过程中同时计算各节点的nullable，firstpos，lastpos，计算方法参考Methods中的补全表）：</p>
<ul>
<li>输入：后缀正则表达式</li>
<li>输出：该正则表达式的语法分析树</li>
<li>方法：<ul>
<li>使用一个栈A作为节点寄存栈，节点里存放的是当前抽象意义上的操作数。</li>
<li>遇到一个操作数，则构造一个节点，压栈。</li>
<li>遇到’<em>‘，从栈里弹出一个节点作为\</em>的子节点，压栈。</li>
<li>遇到’|’或者’&amp;’，从栈里弹出两个节点作为它的右左节点（注意顺序），第一个弹出的是右节点，压栈。</li>
<li>如果正则表达式正确，栈中最后会剩一个节点，即整个正则分析树的根节点。</li>
</ul>
</li>
</ul>
</li>
<li><p>先序遍历正则分析树，产生所有位置节点的followpos，因为计算followpos的方法只涉及firstpos和lastpos，因此可以采用先序遍历的方法，自顶向下构造：</p>
<ul>
<li>输入：正则语法分析树</li>
<li>输出：该树位置节点的followpos</li>
<li>方法：<ul>
<li>先序遍历该树，直到最后一个节点：</li>
<li>对于cat节点，cat节点左子女的lastpos的followpos肯定包含cat节点右子女的firstpos</li>
<li>对应star节点，因为可以自环，所有自身的lastpos的followpos肯定包含自身的firstpos</li>
</ul>
</li>
</ul>
</li>
<li><p>由正则分析树构造DFA状态集</p>
<ul>
<li>输入：正则分析树</li>
<li>输出：DFA状态集和DFATurn</li>
<li>方法：<ul>
<li>构造两个状态集，已标记状态集A和未标记状态集B。</li>
<li>将根节点的firstpos作为开始状态加入未标记状态集</li>
<li>只要未标记状态集非空，便选择一个状态S将其置于标记状态集，对于每个标识符a，令U为该状态和标识符a对应的所有位置p的followpos(p)的并集，如果U不在状态集中，则将U加入到未标记状态集中，同时在S的DFATurn map中增加一条（a，U）。</li>
<li>未标记状态集为空，则已标记状态集中便是DFA的所有状态，且每个状态的DFATurn合到一起便是DFA转换表。</li>
<li>删除A中的空状态，由于算法实际编写时的缺陷，可能会产生一定数量的空状态：该状态没有任何位置节点，删去这样的空状态。</li>
</ul>
</li>
</ul>
</li>
<li><p>由DFA构造具有最少状态的DFA（与《编译原理》略有不同）：</p>
<ul>
<li><p>输入：DFA状态集和各状态的DFATurn</p>
</li>
<li><p>输出：具有最少状态的DFA和各状态的DFATurn</p>
</li>
<li><p>方法：</p>
<ul>
<li>构造一个划分A，包含两个组p和q，p是DFA的接受状态组，q是非接受状态组</li>
<li>构造一个空的新划分B</li>
<li>对于划分A中的每个组a的所有状态s，检查s能否加入到新划分的一个分组里，可以加到该分组的条件是该分组内的某个状态s1和s对于所有终结符的下一转换状态在A的同一个分组里。如果可以加入，则加入，否则，新建一个分组b，分配b的id号，将s加入分组b，将b加入到新划分B中。</li>
<li>最后，如果B和A的大小相同，则代表算法第一阶段结束，进入第二阶段，否则用B代替A，新建一个空划分代替B，重复算法第三步。</li>
<li>对于每个分组，选择一个代表状态s，将s的id号设置为该分组的id号，将s的turn状态改为原来turn状态所在其他分组的代表状态s。</li>
<li>新产生的状态s的集合即为新的DFA集，每个s有自己的DFATurn。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>lexical analyzer模块</p>
<ul>
<li><p>根据字符流和DFA产生一个token</p>
<ul>
<li><p>输入：字符流、Set\<dfastate></dfastate></p>
</li>
<li><p>输出：一个合法token</p>
</li>
<li>方法：<ul>
<li>使用一个单字节peek作为预读， 一个状态S赋值为DFA的开始状态，过滤掉空字符，对于m每个合法的peek，找到DFATurn（S，peek）将下一状态作为S，直到遇到非法字符或者#，检查S是否是接受状态，如果是接受状态，则返回这一过程中产生的这个token。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="Use-cases"><a href="#Use-cases" class="headerlink" title="Use cases"></a>Use cases</h1><p>测试用例位于test包内，共有三组，对于上述的每组正则表达式组i，构造了两个输入流Streamia，Streamib，测试时首先使用lex模块接收正则表达式组i输出DFA状态集，再调用lexical analyzer模块接收输入流，利用DFA状态集产生token序列。所以每个测试用例输出的内容有DFA和token序列。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">DFA states</span><br><span class="line">id: 1</span><br><span class="line">type: ACCEPT</span><br><span class="line">turn :</span><br><span class="line">a: 7</span><br><span class="line">b: 4</span><br><span class="line">c: </span><br><span class="line">#: </span><br><span class="line"></span><br><span class="line">id: 2</span><br><span class="line">type: ACCEPT</span><br><span class="line">turn :</span><br><span class="line">a: 3</span><br><span class="line">b: 6</span><br><span class="line">c: </span><br><span class="line">#: </span><br><span class="line"></span><br><span class="line">id: 3</span><br><span class="line">type: SIMPLE</span><br><span class="line">turn :</span><br><span class="line">a: 5</span><br><span class="line">b: 4</span><br><span class="line">c: </span><br><span class="line">#: </span><br><span class="line"></span><br><span class="line">id: 4</span><br><span class="line">type: ACCEPT</span><br><span class="line">turn :</span><br><span class="line">a: 12</span><br><span class="line">b: 5</span><br><span class="line">c: </span><br><span class="line">#: </span><br><span class="line"></span><br><span class="line">id: 5</span><br><span class="line">type: ACCEPT</span><br><span class="line">turn :</span><br><span class="line">a: 9</span><br><span class="line">b: 2</span><br><span class="line">c: </span><br><span class="line">#: </span><br><span class="line"></span><br><span class="line">id: 6</span><br><span class="line">type: START</span><br><span class="line">turn :</span><br><span class="line">a: 3</span><br><span class="line">b: 6</span><br><span class="line">c: </span><br><span class="line">#: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tokens on stream 3a</span><br><span class="line">aaa</span><br><span class="line">aaaa</span><br><span class="line">aaaaa</span><br><span class="line">bbaa</span><br><span class="line">bbaab</span><br><span class="line">bbaaba</span><br><span class="line"></span><br><span class="line">tokens on stream 3b</span><br><span class="line">aaabbb</span><br><span class="line">aaaaabb</span><br><span class="line">aaaaaabbab</span><br><span class="line">bbaaabb</span><br><span class="line">bbaabbb</span><br><span class="line">bbaabab</span><br></pre></td></tr></table></figure>
<h1 id="Problems-occurred-and-related-solutions"><a href="#Problems-occurred-and-related-solutions" class="headerlink" title="Problems occurred and related solutions"></a>Problems occurred and related solutions</h1><ul>
<li><p>循环结构太过复杂导致分析问题困难，如图是上述算法中的DFA-&gt;DFA with minimum states的初始版本，其中使用了5层嵌套循环，出错时调试了好久。解决方案：将该算法分解为三步，DFA-&gt;DFA with minimum states、寻找一个状态能否加入到新的划分里、判断两个状态是否属于同一划分。</p>
<p><img src="..\images\3.png" alt="1540860008570"></p>
</li>
<li><p>正则表达式以’#’为结束符，《编译原理》中在分析NFA的重要状态时说：“我们可以在一个正则表达式r的右端连接一个独特的右端结束标记符#，使得r的结束状态增加一个在#上的转换，使之成为(r)#NFA的重要状态，换句话说，通过使用扩展的正则表达式(r)#，我们可以在构造过程中不考虑接受状态的问题。当构造过程结束后，任何在#上有离开转换状态的状态必然是一个结束状态。”这一段话在手动操作时很容易实现，先增加一个#作为结束符，在最后对所有接受状态做修正即可，然而编码中没有找到可以修正接受状态的方法，因为构造最小状态集的DFA改变了与#有关的状态的转换情况，如果不增加#作为结束符，则又会因为缺少重要状态导致产生了错误的DFA，因此在最后保留了#这一结束符。这一问题《编译原理》中也没有给出“构造过程结束后，任何在#上有离开转换状态的状态必然是一个结束状态”该如何来实现，存疑。</p>
</li>
<li><p>DFA状态的最小化：《编译原理》中对DFA状态的最小化所描述的算法是不能直接拿来编程的，因为对一个划分中的每个分组，将该分组分为更小的组，这个分组的方法是通过观察法实现的，因此将该算法改良为可编程算法，（参考本文档Core Algorithms中的由DFA构造具有最少状态的DFA）取出G中的每个状态，来判断它是否能加入新划分的某个分组中，若不能加入，则新增分组。</p>
</li>
</ul>
<h1 id="Feelings-and-Comments"><a href="#Feelings-and-Comments" class="headerlink" title="Feelings and Comments"></a>Feelings and Comments</h1><ul>
<li>Lex模块结合《编译原理》完成，练习使用了多种数据结构：tree，map，set，stack，对于阅读一个算法的伪代码或者文字描述来转换成实际代码有了提升。</li>
<li>《编译原理》中的预备知识很重要，比如NFA的重要状态一节解释了为什么需要一个#作为结束状态，在设计lex时应该按照先构造(r)#的DFA，再根据#的接受状态还原r的DFA，没有遵循这一流程导致还原r困难。</li>
</ul>
<p><a href="https://github.com/PErFeCtISHiT/compiler-disassembling-assembly/tree/master/lex" target="_blank" rel="noopener">项目源码</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/12/数据库设计-移动运营商业务数据库说明文档/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sf.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="somnus">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/12/数据库设计-移动运营商业务数据库说明文档/" itemprop="url">数据库设计-移动运营商业务数据库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-12T13:05:34+08:00">
                2018-10-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/基础/" itemprop="url" rel="index">
                    <span itemprop="name">基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h1><ul>
<li>实现内容：使用MySQL关系型数据库，设计关于运营商数据库的所有表，使用java代码生成测试数据，对测试数据进行查找测试</li>
<li>开发平台：IntelliJ IDEA Ultimate，MySQL Workbench 6.3 CE</li>
<li>使用技术：java、hibernate orm架构、mysql、spring boot、jpa、</li>
<li>设计模式：模板模式</li>
<li>项目地址：<a href="https://github.com/PErFeCtISHiT/database-exercise" target="_blank" rel="noopener">运营商数据库</a></li>
</ul>
<h1 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h1><ul>
<li><p>创建数据库并授予权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create database businessDB</span><br><span class="line">grant all privileges on businessDB.* to user@localhost identified by &apos;password′;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<ul>
<li><p>采用hbm2ddl 来定义数据库结构，ddl是一种sql语言，用来定义数据库的结构，如建立一张表，创建一个数据库，hbm2ddl是hibernate框架用来自动创建|更新|验证数据库表结构的一个工具。第一次加载hibernate时根据model类会自动建立起表的结构（前提是先建立好数据库），以后加载hibernate时根据model类自动更新表结构，即使表结构改变了但表中的行仍然存在不会删除以前的行。具体创建方法是hibernate去根据java代码中的Entity类创建数据表。</p>
</li>
<li><p>数据库可以通过dbscript.sql文件来生成，dbscript.sql文件是项目完成后生成的源数据脚本。实现了建表和测试数据生成。</p>
</li>
<li><p>数据库ER图：</p>
<p><img src="..\images\1540270255808.png" alt="54027025580"></p>
<ul>
<li>user表记录了用户的id，当月通话时间、短信条数、国内外流量使用</li>
<li>user_discount是一张关联表，记录了user_id，discount_id，反应用户当前套餐的关系（退订会影响该表）（不同套餐可以叠加）</li>
<li>discount记录了套餐的id，名称，功能费，通话时间、短信条数、国内外流量。</li>
<li>user_order记录了订单的id、user_id（外键）、discount_id（外键）、订购时间，记录的是用户订购套餐的历史（退订不会影响该表）</li>
<li>bill记录了月账单的id、日期、通话时间、短信条数、国内外流量、user_id（外键）、通话资费、信息资费、本地流量资费、全国流量资费。其中各项资费均记录套餐外产生的资费。</li>
<li>flow_record记录了流量记录的id，日期，国内外流量，资费。</li>
<li>call_record记录了通话记录的id，日期，通话时长，资费。</li>
</ul>
</li>
<li><p>资费设计,因为优惠套餐可以叠加，所以超出套餐部分按照基准资费计算，优惠套餐本身不考虑超出后计费问题。</p>
<ul>
<li><p>基准资费</p>
<ul>
<li>通话费用：0.5元/分钟（仅拨打收费，接听免费）</li>
<li>短信费用：0.1元/条</li>
<li>本地流量费用（仅考虑4G流量）：2元/M</li>
<li>国内流量费用（仅考虑4G流量）：5元/M</li>
</ul>
</li>
<li><p>优惠套餐</p>
<ul>
<li>话费套餐：月功能费20元，最多可拨打100分钟电话</li>
<li>短信套餐：月功能费10元，最多可发送200条短信</li>
<li>本地流量套餐：月功能费20元，最多可获得2G流量，仅在本地使用</li>
<li>国内流量套餐：月功能费30元，最多可获得2G流量。</li>
<li>混合套餐：月功能费40元，最多可拨打50分钟电话，发生100条短信，获得1G本地流量，1G国内流量（多种优惠）</li>
</ul>
<p>​</p>
</li>
</ul>
</li>
<li><p>后端使用ORM架构，利用OneToMany，ManyToOne，ManyToMany等完成表之间的映射关系。例如：<img src="..\images\1539326429599.png" alt="53932642959"></p>
</li>
</ul>
<h1 id="后端实现"><a href="#后端实现" class="headerlink" title="后端实现"></a>后端实现</h1><h1 id="测试数据生成"><a href="#测试数据生成" class="headerlink" title="测试数据生成"></a>测试数据生成</h1><p>先分析一段导出的sql脚本</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`user`</span>;</span><br><span class="line"><span class="comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;</span><br><span class="line"><span class="comment">/*!40101 SET character_set_client = utf8 */</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`call_month`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`internal_flow_month`</span> <span class="keyword">double</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`local_flow_month`</span> <span class="keyword">double</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`message_month`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">3</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"><span class="comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Dumping data for table `user`</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">LOCK</span> <span class="keyword">TABLES</span> <span class="string">`user`</span> WRITE;</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `user` DISABLE KEYS */</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">150</span>,<span class="number">200</span>,<span class="number">5000</span>,<span class="number">260</span>),(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `user` ENABLE KEYS */</span>;</span><br><span class="line"><span class="keyword">UNLOCK</span> <span class="keyword">TABLES</span>;</span><br></pre></td></tr></table></figure>
<p>插入数据的基本操作便是占用写锁、插入数据、释放写锁。编写testDataGenerator类来产生测试数据（基本表各10万条，关联表视情况而定），将测试数据写入若干sql文件中，在mysql控制台运行该脚本便生成了测试数据。</p>
<p><img src="..\images\1539421717594.png" alt="53942171759"></p>
<p>插入20万条数据：</p>
<p><img src="..\images\1539423180784.png" alt="53942318078"></p>
<h2 id="模板模式"><a href="#模板模式" class="headerlink" title="模板模式"></a>模板模式</h2><p><strong>意图：</strong>定义一个操作中的算法的骨架，而将一些步骤延迟到子类中。模板方法使得子类可以不改变一个算法的结构即可重定义该算法的某些特定步骤。</p>
<p><strong>主要解决：</strong>一些方法通用，却在每一个子类都重新写了这一方法。</p>
<p><strong>使用场景：</strong> 1、有多个子类共有的方法，且逻辑相同。 2、重要的、复杂的方法，可以考虑作为模板方法。</p>
<p>在设计数据库服务类时，便使用到了模板模式，不管是那张表，因为jpa对操作进行了封装，可以利用object进行操作，因此对数据库的操作有一部分是相同的，如根据primary key查找，新增，修改，删除，统计个数，判断是否存在，清空表。在设计中建立抽象类PublicService，声明了一个泛型JpaRepository以及上述方法，所有继承PublicService的类都要去自己定义自己的JpaRepository，之后，便可以直接复用父类的方法。减少重复代码。</p>
<p><img src="C:\hexo\source\images\1539601810131.png" alt="53960181013"></p>
<h2 id="数据库相关操作"><a href="#数据库相关操作" class="headerlink" title="数据库相关操作"></a>数据库相关操作</h2><p>Main.java每次运行会在10万名用户中抽取10名，查询当前套餐，查询历史套餐，订购套餐1，退订套餐1（立即生效或下个月生效），生成通话资费，生成流量资费，查询月账单，经测试，平均每个操作约耗时100毫秒，最多的耗时为1000毫秒。</p>
<ul>
<li><p>对某个用户进行套餐的查询（包括历史记录），使用@ManyToMany进行user表与discount表的关联映射，当需要加载某个用户的Set<discountentity> discountEntities时，hibernate通过lazy initialize去查找这个用户的discount，历史记录同理，建立ures与order表的关联映射，Set<orderentity> orderEntities记录了用户的历史记录。</orderentity></discountentity></p>
<p><img src="C:\hexo\source\images\1539604919402.png" alt="53960491940"></p>
</li>
<li><p>订购、退订（考虑立即生效和次月生效）操作，订购套餐即先lazy initialize某个用户的所有套餐，再在这个set里添加一项，通过jpa封装的modify将事务提交至mysql数据库，退订同理，次月生效的退订使用了java的TimerTask类来进行延时处理。</p>
<p><img src="C:\hexo\source\images\1539604942442.png" alt="53960494244"></p>
</li>
<li><p>某个用户在通话情况下的资费生成，得到用户当月的套餐，计算出套餐外的通话量，产生通话记录。</p>
<p><img src="..\images\1540271700389.png" alt="54027170038"></p>
</li>
<li><p>某个用户在使用流量情况下的资费生成，同上。</p>
<p><img src="..\images\1540272388161.png" alt="54027238816"></p>
</li>
<li><p>某个用户月账单的生成，用户信息中记录了用户当月的各类服务使用量，user与discount表关联得到了用户的优惠套餐，用使用量减去优惠套餐得到了优惠套餐之外的额外消费，产生月账单记录。</p>
<p><img src="C:\hexo\source\images\1539604997520.png" alt="53960499752"></p>
</li>
</ul>
<h1 id="项目回顾"><a href="#项目回顾" class="headerlink" title="项目回顾"></a>项目回顾</h1><ul>
<li><p>设计方案</p>
<ul>
<li>用户套餐关系中，使用了两张表user_discount和user_order来反应不同的关系，前者反应用户当前的套餐，后者反应套餐历史，而不是选择使用一张表来记录用户的所有套餐，再用一个标志位来区分是当前套餐还是套餐历史，是考虑到了时间效率，因为用户更加经常做的事情是去查看自己当前的套餐情况，如果使用一张表的设计，查询所有的套餐历史再去筛选当前套餐，会影响数据库效率，用户当前的套餐数量远小于历史套餐数量。（两张表代替一张表，空间换取时间）</li>
<li>用户账单关系中，考虑到需要的操作：某个用户在通话情况下的资费生成、某个用户在使用流量情况下的资费生成、某个用户月账单的生成，应该设计三个表：用户通话总资费，用户流量总资费、用户月账单总资费，但是这样设计会加重与数据库交互的后端的任务，因为每当月底生成月账单时，后端要记得去三个表里修改数据，用户的通话增加了，流量增加了，月账单也要更新，如果这样设计数据库，在月底结账那一天数据库的负担会很大，要更新三张表里面许多的冗余数据，因此这里只设计了一张表，即用户月账单，用户通话的总资费可以去将所有月账单的通话累积，流量同理，这样设计带来的问题是获取用户通话总资费会进行更多的查询操作，但是这样可以将负担分配到每一天，因为这几个操作是随机进行的，而不像月底结账一样数据量繁重。牺牲单个用户进行某个操作的效率换取了对全体用户维持三个表带来的负担。（一张表代替三张表，分散数据库压力）</li>
</ul>
</li>
<li><p>遇到的问题</p>
<ul>
<li><p>LazyInitializationException，曾经遇到过这个问题，没有做深入了解便轻易将fetchtype换成eager，对于小数据量来说是一个解决方案，然而这个项目中设计了10万条测试，遇到这个异常时我把所有的fetchtype都换成了eager，急加载所有数据，换来的代价就是查找一个记录需要一分多钟，将sql内容输出到日志才发现，如果要查找某个用户和他的所有套餐，原先的操作可能是</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> userentity0_.id <span class="keyword">as</span> id1_2_0_, userentity0_.call_month <span class="keyword">as</span> call_mon2_2_0_, userentity0_.internal_flow_month <span class="keyword">as</span> internal3_2_0_, userentity0_.local_flow_month <span class="keyword">as</span> local_fl4_2_0_, userentity0_.message_month <span class="keyword">as</span> message_5_2_0_ <span class="keyword">from</span> <span class="keyword">user</span> userentity0_ <span class="keyword">where</span> userentity0_.id=?</span><br><span class="line"><span class="keyword">select</span> discounten0_.user_entities_id <span class="keyword">as</span> user_ent1_4_0_, discounten0_.discount_entities_id <span class="keyword">as</span> discount2_4_0_, discounten1_.id <span class="keyword">as</span> id1_1_1_, discounten1_.call_count <span class="keyword">as</span> call_cou2_1_1_, discounten1_.internal_flow <span class="keyword">as</span> internal3_1_1_, discounten1_.local_flow <span class="keyword">as</span> local_fl4_1_1_, discounten1_.message_count <span class="keyword">as</span> message_5_1_1_, discounten1_.discount_name <span class="keyword">as</span> discount6_1_1_, discounten1_.price <span class="keyword">as</span> price7_1_1_ <span class="keyword">from</span> user_discount discounten0_ <span class="keyword">inner</span> <span class="keyword">join</span> discount discounten1_ <span class="keyword">on</span> discounten0_.discount_entities_id=discounten1_.id <span class="keyword">where</span> discounten0_.user_entities_id=?</span><br></pre></td></tr></table></figure>
<p>，先找到这个用户，再去找他跟其他表的关联，由于使用了急加载，所有跟user有关的表都被先查询，在筛选用户之前，便对10万个用户与他们的10万条优惠套餐做了笛卡儿积，最终所有操作加起来用时超过了三分钟，产生了近百兆的日志文件，lazy initialize允许加载一个对象时先不加载这个对象的这个属性，当使用它时，hibernate再去数据库获取，在数据量相当大时比eager initialize的性能要有显著优化。解决LazyInitializationException的方法则是使用@Transactional注解去管理事务。</p>
</li>
</ul>
</li>
<li><p>主键索引</p>
<p>由于设计中对数据库的操作可以通过查询主键+表的关联映射来实现，使用lazy initialize可以在数据量较大的时候先定位到需要找的几个元素，再针对这几个元素关联查找，所有的查询语句都建立在仅查询主键的情况下完成，在建表时便建立好了主键索引，因此项目中的所有查询操作均是在索引结构中完成的。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/09/IDA-pro 第一次反汇编/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sf.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="somnus">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/09/IDA-pro 第一次反汇编/" itemprop="url">IDA-pro</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-09T19:48:14+08:00">
                2018-10-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/逆向工程/" itemprop="url" rel="index">
                    <span itemprop="name">逆向工程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>The official line is: IDA Pro combines an interactive, programmable, multi-processor<br>disassembler coupled to a local and remote debugger and augmented by a complete plugin<br>programming environment. </p>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>参考官方教程：</p>
<p><a href="https://www.hex-rays.com/products/ida/support/tutorials/debugging_win32.pdf" target="_blank" rel="noopener">Using IDA Pro&amp;s Debugger</a></p>
<p>从一段代码开始：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">char_average</span><span class="params">(<span class="keyword">char</span> <span class="built_in">array</span>[], <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">int</span> i;</span><br><span class="line"> <span class="keyword">char</span> average;</span><br><span class="line"> average = <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line"> average += <span class="built_in">array</span>[i];</span><br><span class="line"> average /= count;</span><br><span class="line"> <span class="keyword">return</span> average;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">int_average</span><span class="params">(<span class="keyword">int</span> <span class="built_in">array</span>[], <span class="keyword">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">int</span> i, average;</span><br><span class="line"> average = <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line"> average += <span class="built_in">array</span>[i];</span><br><span class="line"> average /= count;</span><br><span class="line"> <span class="keyword">return</span> average;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">char</span> chars[] = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line"> <span class="keyword">int</span> integers[] = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"chars[] - average = %d\n"</span>,</span><br><span class="line"> char_average(chars, <span class="keyword">sizeof</span>(chars)));</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"integers[] - average = %d\n"</span>,</span><br><span class="line"> int_average(integers, <span class="keyword">sizeof</span>(integers)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有两个求char数组与int数组均值的函数，具体过程十分简单，然而运行这段代码就会发现int_average这个函数出了问题，如果不用IDA-pro去直接调试也很容易发现问题：sizeof(integers)计算的是这个数组的大小（以字节为单位），因此传递的参数出了问题。下面开始使用IDA-pro。</p>
<p>因为IDA是一款反汇编软件，这里选择open一个生成好的.exe可执行映像（如图）</p>
<p><img src="..\images\1539167453853.png" alt="53916745385"></p>
<p>这里显示文本的方式与官方文档中不同，可以在右边空白位置右击选择text view就可以得到正常的显示，然后可以看到，IDA对.exe文件进行了反汇编（事后也试过对.jar进行反汇编，然而产生的代码根本看不懂。。。）。可以很清楚的看到几个函数块都被IDA检测到，当你想知道一个地址上下左右都是什么值，或者这个寄存器目前的值是什么时，只需要将鼠标移动到该变量处（这功能好强大），接下来就是跟其他IDE一样的操作，设置断点，调试，官方文档中的调试可以看到view-EIP（代码执行处），view-ESP（栈），如果没有显示的部分可以在windows下面找到general registers，打开对应的register view就ok了。</p>
<p><img src="..\images\1539139488272.png" alt="53913948827"></p>
<p>这里可以看到在代码的00401575h处，编译器将14h放入参数列表，这个14h就是前面的sizeof(integers) （20），后面还很贴心地给出了注释（count），也就找到了问题所在，这里不知道这个20是怎么计算出来的，可能经过了编译优化，直接将一个20立即数作为了参数。IDA对汇编语言的处理能力和反汇编是我用过的里面最好用的一款（然而到现在也就用过这一款233333）</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/09/windows程序设计/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sf.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="somnus">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/09/windows程序设计/" itemprop="url">windows程序设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-09T19:47:45+08:00">
                2018-10-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/逆向工程/" itemprop="url" rel="index">
                    <span itemprop="name">逆向工程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/09/啄食成器/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sf.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="somnus">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/09/啄食成器/" itemprop="url">啄食成器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-09T19:47:34+08:00">
                2018-10-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/逆向工程/" itemprop="url" rel="index">
                    <span itemprop="name">逆向工程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/19/gitlab-server/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sf.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="somnus">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/19/gitlab-server/" itemprop="url">gitlab-server</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-19T22:45:48+08:00">
                2018-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="搭建gitlab服务器"><a href="#搭建gitlab服务器" class="headerlink" title="搭建gitlab服务器"></a>搭建gitlab服务器<br></h1><h2 id="服务器内存一定不能太小（2G-）…-不然就会像这样https-stackoverflow-com-questions-28286002-ruby-cannot-allocate-memory"><a href="#服务器内存一定不能太小（2G-）…-不然就会像这样https-stackoverflow-com-questions-28286002-ruby-cannot-allocate-memory" class="headerlink" title="服务器内存一定不能太小（2G+）….. 不然就会像这样https://stackoverflow.com/questions/28286002/ruby-cannot-allocate-memory"></a>服务器内存一定不能太小（2G+）….. 不然就会像这样<code>https://stackoverflow.com/questions/28286002/ruby-cannot-allocate-memory</code></h2><h2 id="搭建参考最好的文档–https-docs-gitlab-com-omnibus-README-html-，https-about-gitlab-com-installation-这里可以看到哪些版本的服务器可以搭建gitlab（刚开始用Ubuntu12失败了好几次。。。。），安装过程中需要注意的地方在于EXTERNAL-URL，指的是服务器所在URL，不是域名，应该填服务器对应IP，此外，gitlab-ctl用于各种gitlab命令，第一次安装最好使用gitlab-ctl-reconfigure进行配置。。。文档里面还有很多搭建配置233333还没有看完。下一步准备启用https"><a href="#搭建参考最好的文档–https-docs-gitlab-com-omnibus-README-html-，https-about-gitlab-com-installation-这里可以看到哪些版本的服务器可以搭建gitlab（刚开始用Ubuntu12失败了好几次。。。。），安装过程中需要注意的地方在于EXTERNAL-URL，指的是服务器所在URL，不是域名，应该填服务器对应IP，此外，gitlab-ctl用于各种gitlab命令，第一次安装最好使用gitlab-ctl-reconfigure进行配置。。。文档里面还有很多搭建配置233333还没有看完。下一步准备启用https" class="headerlink" title="搭建参考最好的文档–https://docs.gitlab.com/omnibus/README.html ，https://about.gitlab.com/installation/这里可以看到哪些版本的服务器可以搭建gitlab（刚开始用Ubuntu12失败了好几次。。。。），安装过程中需要注意的地方在于EXTERNAL_URL，指的是服务器所在URL，不是域名，应该填服务器对应IP，此外，gitlab-ctl用于各种gitlab命令，第一次安装最好使用gitlab-ctl reconfigure进行配置。。。文档里面还有很多搭建配置233333还没有看完。下一步准备启用https"></a>搭建参考最好的文档–<code>https://docs.gitlab.com/omnibus/README.html</code> ，<code>https://about.gitlab.com/installation/</code>这里可以看到哪些版本的服务器可以搭建gitlab（刚开始用Ubuntu12失败了好几次。。。。），安装过程中需要注意的地方在于EXTERNAL_URL，指的是服务器所在URL，不是域名，应该填服务器对应IP，此外，gitlab-ctl用于各种gitlab命令，第一次安装最好使用<code>gitlab-ctl reconfigure</code>进行配置。。。文档里面还有很多搭建配置233333还没有看完。下一步准备启用https</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/06/cpp进阶/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sf.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="somnus">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/06/cpp进阶/" itemprop="url">cpp进阶</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-06T14:36:57+08:00">
                2018-07-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/基础/" itemprop="url" rel="index">
                    <span itemprop="name">基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="..\images\cpp.png" alt="image"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/02/acm/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sf.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="somnus">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/02/acm/" itemprop="url">acm</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-02T15:55:52+08:00">
                2018-07-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="acm练习笔记"><a href="#acm练习笔记" class="headerlink" title="acm练习笔记"></a>acm练习笔记</h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/01/oslab-process/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sf.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="somnus">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/01/oslab-process/" itemprop="url">oslab-process</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-01T08:37:09+08:00">
                2018-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/基础/" itemprop="url" rel="index">
                    <span itemprop="name">基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="os进程调度"><a href="#os进程调度" class="headerlink" title="os进程调度"></a>os进程调度</h1><h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><p>实现系统调用，并用pv操作解决睡眠理发师问题。</p>
<h3 id="遇到的问题及解决"><a href="#遇到的问题及解决" class="headerlink" title="遇到的问题及解决"></a>遇到的问题及解决</h3><ol>
<li>系统调用<br>orange’s提供了实现系统调用的方法，入口是非系统调用函数x，对应一个中断向量，调用sys_x，需要预先准备好调用函数的堆栈大小，函数声明。参数传递的策略，在<br>x中使用ebp接收参数，压入ebx，在sys_call中压入ebx传递参数，在sys_x中使用c语言接收参数。输出字符串的系统调用时发生pf page fault，疑似那几个进程上下文转换出问题，在main函数中调用x来调用系统调用都可以正常使用（未解决）。</li>
<li>进程<br>在proc.h中设置进程的基本信息，增加了休眠状态、休眠时间来实现休眠的系统调用。在main.c中编写进程的具体实现。</li>
<li>semaphore<br>定义semaphore.h这个头文件来定义信号量数据结构，每个信号量有一个进程队列，有pv操作，（pv系统调用也剥离出了调用pv系统调用的pv函数），其中pv操作的p操作中必须要加milli_delay(50);不然会报分页错误，原因尚不明确，可能是p操作中发生进程调度会导致出错。pv操作通过将进程移入等待队列、修改进程状态来实现进程的睡眠、唤醒。并且修改了进程调度函数，睡眠和等待的程序不参与调度。</li>
<li>main.c<br>main.c里需要附加的工作是给进程一个初始状态，初始化每个信号量，这里初始化信号量时注意要给它的队列指针附地址，一开始这里没有指明地址一直报缺页de了好久。。。。（将一切初始化交给自己做）</li>
<li>睡眠理发师问题<br>这里我对信号量的理解是互斥的信号量各个进程用同一种，看做是一个锁，只能有若干个进程在用，同步的信号量在不同进程中的职责不同，比如barber在理发师这个进程里用来唤醒理发师的服务，提供给客户理发，而在客户那边却看做申请一个理发师资源，如果申请不到会等待，而consumer这个信号量在理发师这边则是申请一个客户，在客户那边是释放自己的资源给理发师使用，两种信号量互相传递给对方，在对方进程中释放，是一个协作的关系。</li>
<li>寻找报错原因<br>实验中几乎所有的报错都只会显示一个page fault，很难找到错误原因，最后不得不用控制变量法在确保正确的地方开始，逐步增加条件，直到报错，找到错误。（其实更好的办法是看报缺页的地址再拿出来解析）</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/sf.png" alt="John Doe">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
